<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Mapa de Cadáveres Inmobiliarios</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>

<script src="L.GeoSearch/js/l.control.geosearch.js"></script>
<script src="L.GeoSearch/js/l.geosearch.provider.openstreetmap.js"></script>
<link rel="stylesheet" href="L.GeoSearch/css/l.geosearch.css" />

<script src="leaflet-sidebar/L.Control.Sidebar.js"></script>
<link rel="stylesheet" href="leaflet-sidebar/L.Control.Sidebar.css" />

<link rel="stylesheet" href="styles.css" />
</head>

<body>
<div id="sidebar">
	<h2>leaflet-sidebar</h2>
</div>

<div id="map"></div>

<script>
// TILES: base layers
var tilesUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}';
var tilesAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>';
var baseVector = L.tileLayer(tilesUrl, {
	attribution: tilesAttr,
	maxZoom: 18,
	id: 'skotperez.nkgo660p',
	accessToken: 'pk.eyJ1Ijoic2tvdHBlcmV6IiwiYSI6ImNpZmVjMWd1bTAwZnp1Y2tuenhncHlvNHMifQ.yHojMKQz04-JIz6N4HyjyA'
});
var baseSatellite = L.tileLayer(tilesUrl, {
	attribution: tilesAttr,
	maxZoom: 18,
	id: 'skotperez.nnf00875',
	accessToken: 'pk.eyJ1Ijoic2tvdHBlcmV6IiwiYSI6ImNpZmVjMWd1bTAwZnp1Y2tuenhncHlvNHMifQ.yHojMKQz04-JIz6N4HyjyA'
});

// STYLES: markers
var styleOut = {
    radius: 9,
    fillColor: "#fc0",
    color: "#666",
    weight: 1,
    opacity: 0.8,
    fillOpacity: 1
}
var styleOver = {
    color: "#000",
    weight: 5
}
var styleClick = {
    color: "#666",
    weight: 5
}
function resetMarkersStyle(layer) {
	layer.eachLayer(function(l){
		l.setStyle(styleOut);
	});
}

// CONTENT
// About
var aboutCadaveres = "<header><h1>Cadáveres Inmobiliarios</h1></header><div class='excerpt'><img class='push-left' src='images/logo.png' alt='Logo Cadáveres' /><p><em>Base de datos de proyectos arquitectónicos y desarrollos urbanísticos inacabados, infrautilizados o vacíos del periodo post-burbuja inmobiliaria.</em><br /><a href='http://cadaveresinmobiliarios.org'>cadaveresinmobiliarios.org</a></p><ul class='list-inline'><li><a class='social hide-text social-tw' href='http://twitter.com/cadaveres_inmob' title='Twitter Cadáveres'>Twitter</a></li><li><a class='social hide-text social-fb' href='https://www.facebook.com/cadaveres.inmobiliarios' title='Facebook Cadáveres'>Facebook</a></li><li><a class='social hide-text social-gh' href='http://github.com/cadaveresinmob' title='Repositorio de código'>Github</a></li><li><a class='social hide-text social-ml' href='https://groups.google.com/d/forum/hacia-base-datos-inmobiliaria' title='Lista de correo'>Lista de correo</a></li></ul></div><p>Una de las consecuencias más notables de la actual crisis económica en España es la proliferación de proyectos arquitectónicos y desarrollos urbanísticos inacabados, infrautilizados o vacíos. Macrourbanizaciones fantasma, edificios públicos abandonados o infraestructuras a medio hacer forman hoy parte indeleble de un paisaje sacudido por una absurda megalomanía institucionalizada. Se trata de un fenómeno generalizado a nivel nacional y abarca tanto el plano territorial como el socio-político.</p><p>Ante la inexistencia de un inventario oficial, <strong>Cadáveres Inmobiliarios: Base de datos post-burbuja</strong> nace como un proyecto colectivo que persigue la localización y documentación de todos estos desarrollos que murieron antes de tiempo. Esta iniciativa es de marcado carácter interdisciplinar, englobando arquitectos, ingenieros, urbanistas, investigadores, artistas o activistas medioambientales e invita a la participación al mayor número de personas posible.</p><p>El objetivo de esta ambiciosa recopilación es la de proporcionar información exhaustiva de manera accesible para que cada cual la utilice acorde con sus intereses. Aunque el mero hecho de informar sobre este fenómeno supone una crítica implícita al modelo de desarrollo basado en el ladrillo, 'Cadáveres Inmobiliarios' pretende ser el punto de partida para futuros proyectos que propongan soluciones a situaciones hoy estancadas, fomentando así una concienciación social con respecto a una realidad que nos define y a la que no podemos dar la espalda.</p>";
function aboutSidebar() {
	sidebar.setContent(aboutCadaveres);
	sidebar.show();
}
// image
function imageExists(url) {
	var img = new Image();
	img.src = url;
	return img.height != 0;
}
function imageOutput(src,alt) { return "<figure class='sidebar-img'><img src='"+ src +"' alt='"+ alt +"' /></figure>"; }
//fields
var fieldsToShow = {
	title: {
		nombre_promocional: "Nombre promocional"
	},
	subtitle: {
		estado_actual: "Estado actual"
	},
	address: {
		direccion: "Dirección",
		municipio: "Municipio",
		provincia: "Provincia",
		comunidad_autonoma: "Comunidad autónoma"
	},
	numbers: {
		superficie_terreno: "Superficie terreno (ha)",
		superficie_construida: "Superficie construida (ha)",
		suelo_ocupado_actual: "Suelo ocupado actualmente (ha)"
	},
	actors: {
		promotor: "Promotor",
		constructor: "Constructor",
		arquitecto_o_tecnico_redactor: "Arquitecto / Técnico redactor"
	},
	typology: {
		nombre_urbanistico: "Nombre urbanístico",
		uso: "Uso",
		tipologia_principal_del_asentamiento: "Tipología principal del asentamiento",
		tipologia_secundaria_del_asentamiento: "Tipología secundaria del asentamiento",
		tipologia_edificatoria: "Tipología edificatoria"
	}
};

function fieldsOutput(fields,geojsonLayerProperties,type,cssClass) {
	var fieldsOutput = "";
	var classOut = "sidebar-part";
	if ( cssClass !== null ) { classOut += " "+cssClass; }
	if ( type === 'header' ) {
		for (var p in o = fields) {
			value = geojsonLayerProperties[p]
			if (o.hasOwnProperty(p)) {
				fieldsOutput += "<header class='"+classOut+"'><h3>" +value+ "</h3></header>";
			}		
		}

	} else {
		fieldsOutput += "<dl class='"+classOut+"'>";
		for (var p in o = fields) {
			value = geojsonLayerProperties[p]
			if (o.hasOwnProperty(p) && value != null && value != 'null' && value != '' ) {
				fieldsOutput += "<dt>"+o[p]+"</dt><dd>"+value+"</dd>";
			} else {
				fieldsOutput += "<dt>"+o[p]+"</dt><dd class='no-data'>No definido</dd>";
			}
		}
		fieldsOutput += "</dl>";
	}
	return fieldsOutput;
}
// POPUP
function popupContent(feature) {
	var imageSrc = "images/"+feature.properties.cartodb_id +".jpg";
	var imageAlt = "Foto aérea de "+ feature.properties.nombre_promocional;
	if ( imageExists(imageSrc) ) { var image = imageOutput(imageSrc,imageAlt); }
	else { var image = ""; }
	return image+"<header><h3>" + feature.properties.nombre_promocional + "</h3></header>";
}
// DATA: geoJSON layers
var dataLayer;
function addDataToMap(data,markerStyle) {
	dataLayer = L.geoJson(data, {
		pointToLayer: function (feature, latlng) {
			return L.circleMarker(latlng,markerStyle);
		},
		onEachFeature: function(feature, layer) {
			if( window.location.hash == '#'+layer.feature.properties.cartodb_id ) {
				sidebar.setContent(sidebarContent(layer));
				sidebar.show();
				layer.setStyle(styleClick);
			}

			layer.bindPopup(popupContent(feature),{
				closeButton: false,
				offset: L.point(0,-20),
				maxWidth: 200,
				autoPan: false
			});
			layer.on({
				click: prepareSidebar,
				mouseover: function() {
					layer.openPopup();
					layer.setStyle(styleOver);
					if (!L.Browser.ie && !L.Browser.opera) {
						layer.bringToFront();
					}
				},
				mouseout: function() {
					layer.closePopup();
					if( window.location.hash == '#'+layer.feature.properties.cartodb_id ) {
						layer.setStyle(styleClick);
					} else {
						layer.setStyle(styleOut);
					}
				}
			});
		}
	});
	dataLayer.addTo(map);
}
$.getJSON("data/base_datos_cadaveres_inmobiliarios_151027.geojson", function(data) { addDataToMap(data,styleOut); });

// MAP layer
var mapCenter = [40.11169, -4.13086];
var map = L.map('map', {
	center: mapCenter,
	zoom: 6,
	layers: [baseVector]
});

// CONTROL: layer Switcher
var baseMaps = {
	"Mapa": baseVector,
	"Satélite": baseSatellite
};
L.control.layers(baseMaps).addTo(map);

// SEARCH: Reverse geoCoding
new L.Control.GeoSearch({
	provider: new L.GeoSearch.Provider.OpenStreetMap()
}).addTo(map);

// SIDEBAR
var sidebar = L.control.sidebar('sidebar', {
	closeButton: true,
	position: 'left'
});
map.addControl(sidebar);

setTimeout(function() {
	if( window.location.hash === '#' || window.location.hash === '' ) {
		aboutSidebar();
	}
}, 500);

map.on('click', function () {
	sidebar.hide();
	window.location.hash = '';
})
L.DomEvent.on(sidebar.getCloseButton(), 'click', function () {
	window.location.hash = '';
});

function sidebarContent(layer) {
	// link to About cadaveres
	linkAbout = "<div class='btn-bar'><a class='cadaver-btn' href='#' onClick='jQuery(aboutSidebar())'><span class='icon icon-info'></span> Sobre Cadáveres Inmobiliarios</a></div>";
	// sidebar fields
	title = fieldsOutput(fieldsToShow.title,layer.feature.properties,"header");
	subtitle = fieldsOutput(fieldsToShow.subtitle,layer.feature.properties,"list");
	address = fieldsOutput(fieldsToShow.address,layer.feature.properties,"list","part-bordered");
	numbers = fieldsOutput(fieldsToShow.numbers,layer.feature.properties,"list","part-bordered");
	actors = fieldsOutput(fieldsToShow.actors,layer.feature.properties,"list","part-bordered");
	typology = fieldsOutput(fieldsToShow.typology,layer.feature.properties,"list","part-bordered");
	// sidebar image
	var imageSrc = "images/"+layer.feature.properties.cartodb_id +".jpg";
	var imageAlt = "Foto aérea de "+ layer.feature.properties.nombre_promocional;
	if ( imageExists(imageSrc) ) { var image = imageOutput(imageSrc,imageAlt); }
	else { var image = ""; }
	return linkAbout+title+subtitle+image+address+typology+numbers+actors;
}
function prepareSidebar(e) {
	var layer = e.target;
	resetMarkersStyle(dataLayer);
	layer.setStyle(styleClick);

	if (!L.Browser.ie && !L.Browser.opera) {
		layer.bringToFront();
	}
	sidebar.setContent(sidebarContent(layer));
	if ( !sidebar.isVisible() ) {
		sidebar.toggle();
	}
	window.location.hash = layer.feature.properties.cartodb_id;
}

</script>
</body>
</html>
